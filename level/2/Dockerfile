# -----------------------------------------------
# Level: 2
# Difficulty: Hard
# Categories: Weak File Permissions; Password Cracking
# Description: An exploit chain featuring lateral movement and password cracked from a low-privileged user to root.
# Author: malwaredetective
# Last updated: 06/01/2025
# -----------------------------------------------

FROM khub/root-crawler-base:latest
LABEL project="root-crawler"

# --- Install Required Software Packages ---
RUN apt-get install -y keepassxc

RUN apt-get install -y python3-pykeepass


# --- Create Users ---
RUN useradd -m -s /bin/bash shadowbyte && echo "shadowbyte:blackdragon" | chpasswd && \
echo 'root:no1canH@CKmy5h@dow' | chpasswd 

# --- Configure Privilege Escalation Vulnerability ---
# 1. Update permissions on /etc/shadow to 644, making it world-readable.
# 2. Copy the KeePass database with root credentials. The password was randomly generated by the python script: Botnetworm8
# 3. Uploaded KeePass password cracking tool from https://github.com/thebugitself/Lock-POP/blob/main/lockpop.py. 

COPY password-generator.py /home/shadowbyte/password-generator.py
COPY Database.kdbx /home/shadowbyte/Database.kdbx
COPY lockpop.py /home/shadowbyte/lockpop.py

RUN chmod 644 /etc/shadow && \
chown shadowbyte:shadowbyte /home/shadowbyte/Database.kdbx && chmod 644 /home/shadowbyte/Database.kdbx && \
chown shadowbyte:shadowbyte /home/shadowbyte/password-generator.py && chmod 755 /home/shadowbyte/password-generator.py && dos2unix /home/shadowbyte/password-generator.py && \
chown shadowbyte:shadowbyte /home/shadowbyte/lockpop.py && chmod 755 /home/shadowbyte/lockpop.py && dos2unix /home/shadowbyte/lockpop.py && \
echo "scp shadowbyte@FILE01:/mnt/Share/password-generator.py .\npython3 ./password-generator.py\nkeepassxc-cli db-create --set-password Database.kdbx\nkeepassxc-cli add -u root -p\nkeepassxc-cli open Database.kdbx\nkeepassxc-cli show Database.kdbx root-crawler-level-2\nscp shadowbyte@FILE01:/mnt/Share/lockpop.py .\npython3 ./lockpop.py" > /home/shadowbyte/.bash_history && \
chown shadowbyte:shadowbyte /home/shadowbyte/.bash_history && \
chmod 600 /home/shadowbyte/.bash_history 

# --- Create the Root Flag ---
RUN echo "0e818a27a3fea74347a605528f334e3f" > /root/root.txt && chmod 400 /root/root.txt

# --- Expose SSH port ---
EXPOSE 22

# --- Set the Default Command when the Container Starts ---
CMD ["/usr/sbin/sshd", "-D"]
