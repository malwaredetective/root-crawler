# -----------------------------------------------
# Level: 2
# Difficulty: Medium
# Categories: Weak File Permissions; Password Cracking
# Description: /etc/shadow is readable; The root password is crackable.
# Author: malwaredetective
# Last updated: 06/01/2025
# -----------------------------------------------

FROM khub/root-crawler-base:latest

# --- Install Required Software Packages ---
RUN apt-get install -y keepassxc 

# --- Create Users ---
RUN useradd -m -s /bin/bash shadowbyte && echo "shadowbyte:blackdragon" | chpasswd && \
echo 'root:no1canH@CKmy5h@dow' | chpasswd && \
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config && \
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# --- Configure Privilege Escalation Vulnerability ---
# 1. Copy KeePass Database with Root Credentials. The password was randomly generated by the python script: Botnetworm8
# 2. Changes permissions on /etc/shadow to 644, making it world-readable.
USER shadowbyte
COPY --chown=shadowbyte:shadowbyte password-generator.py /home/shadowbyte/password-generator.py
COPY --chown=shadowbyte:shadowbyte Database.kdbx /home/shadowbyte/Database.kdbx

USER root
RUN  chmod 644 /etc/shadow && \
chown shadowbyte:shadowbyte /home/shadowbyte/Database.kdbx && chmod 644 /home/shadowbyte/Database.kdbx && \
chown shadowbyte:shadowbyte /home/shadowbyte/password-generator.py && chmod 755 /home/shadowbyte/password-generator.py

RUN echo "scp shadowbyte@FILE01:/mnt/Share/password-generator.py .\npython3 ./password-generator.py\nkeepassxc-cli db-create --set-password Database.kdbx\nkeepassxc-cli add -u root -p\nkeepassxc-cli open Database.kdbx\nkeepassxc-cli show Database.kdbx root-crawler-linux-2\nwhich keepass2johnclea" > /home/shadowbyte/.bash_history && \
chown shadowbyte:shadowbyte /home/shadowbyte/.bash_history && \
chmod 600 /home/shadowbyte/.bash_history 

# --- Create the Root Flag ---
RUN echo "0e818a27a3fea74347a605528f334e3f" > /root/root.txt && chmod 400 /root/root.txt

# --- Expose SSH port ---
EXPOSE 22

# --- Set the Default Command when the Container Starts ---
CMD ["/usr/sbin/sshd", "-D"]
